{
  "version": 3,
  "sources": ["../../@thepassle/app-tools/utils/log.js", "../../@thepassle/app-tools/router/index.js"],
  "sourcesContent": ["const KEY = Symbol.for('app-tools::log::1.x');\r\n\r\nglobalThis[KEY] = { \r\n  setDebug, \r\n  debug: 'window' in globalThis ? new URL(window.location.href).searchParams.has('app-tools-debug') : false,\r\n};\r\n\r\n/**\r\n * @param {boolean} value \r\n */\r\nexport function setDebug(value) {\r\n  globalThis[KEY].debug = !!value;\r\n}\r\n\r\n/**\r\n * @returns {boolean}\r\n */\r\nexport function getDebug() {\r\n  return globalThis[KEY].debug;\r\n}\r\n\r\n/**\r\n * @param {string} action - describing the action\r\n * @param {*} [data] - any js value\r\n */\r\nexport function log(action, data) {\r\n  if(globalThis[KEY].debug) {\r\n    console.groupCollapsed(`[app-tools] ${action}`);\r\n    if(data) {\r\n      console.log(data);\r\n    }\r\n    console.groupEnd();\r\n  }\r\n}\r\n\r\n/**\r\n * @param {string} title \r\n * @returns {(action: string, data?: any) => void}\r\n */\r\nexport function createLogger(title) {\r\n  return (action, data) => {\r\n    log(`${title}: ${action}`, data);\r\n  }\r\n}", "import { createLogger } from '../utils/log.js';\r\nconst log = createLogger('router');\r\n\r\nclass RouteEvent extends Event {\r\n  /**\r\n   * @param {Context} context \r\n   */\r\n  constructor(context) {\r\n    super('route-changed');\r\n    this.context = context;\r\n  }\r\n}\r\n\r\n/**\r\n * @typedef {import('./types.js').Plugin} Plugin\r\n * @typedef {import('./types.js').Context} Context\r\n * @typedef {import('./types.js').RouteDefinition} RouteDefinition\r\n * @typedef {import('./types.js').Route} Route\r\n * @typedef {import('./types.js').Config} Config\r\n */\r\n\r\nexport class Router extends EventTarget {\r\n  context = {\r\n    params: {},\r\n    query: {},\r\n    title: '',\r\n    url: new URL(window.location.href),\r\n  }\r\n\r\n  /**\r\n   * @param {Config} config \r\n   */\r\n  constructor(config) {\r\n    super();\r\n    this.config = config;\r\n\r\n    /** @type {Route[]} */\r\n    this.routes = config.routes.map((route) => {\r\n      const r = /** @type {unknown} */ ({\r\n        ...route,\r\n        // @ts-ignore\r\n        urlPattern: new URLPattern({\r\n          pathname: route.path,\r\n          baseURL: window.location.href,\r\n          search: '*',\r\n          hash: '*',\r\n        }),\r\n      });\r\n      return /** @type {Route} */ (r);\r\n    });\r\n    log('Initialized routes', this.routes);\r\n\r\n    queueMicrotask(() => {\r\n      this.navigate(new URL(window.location.href), { replace: true });\r\n    });\r\n    window.addEventListener('popstate', this._onPopState);\r\n    window.addEventListener('click', this._onAnchorClick);\r\n  }\r\n\r\n  uninstall() {\r\n    window.removeEventListener('popstate', this._onPopState);\r\n    window.removeEventListener('click', this._onAnchorClick);\r\n  }\r\n\r\n  get url() {\r\n    return new URL(window.location.href);\r\n  }\r\n\r\n  get fallback() {\r\n    return new URL(\r\n      this.config?.fallback || this.baseUrl.href.substring(window.location.origin.length), \r\n      this.baseUrl\r\n    )\r\n  }\r\n\r\n  get baseUrl() {\r\n    return new URL('./', document.baseURI);\r\n  }\r\n\r\n  /**\r\n   * @template RenderResult\r\n   */\r\n  render() {\r\n    log(`Rendering route ${this.context.url.pathname}${this.context.url.search}${this.context.url.hash}`, { context: this.context, route: this.route });\r\n    return /** @type {RenderResult} */ (this.route?.render?.(this.context));\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   * @param {URL} url \r\n   * @returns {Route | null}\r\n   */\r\n  _matchRoute(url) {\r\n    for (const route of this.routes) {\r\n      const match = route.urlPattern.exec(url);\r\n      if (match) {\r\n        const { title } = route;\r\n        const query = Object.fromEntries(new URLSearchParams(url.search)); \r\n        const params = match?.pathname?.groups ?? {};\r\n        this.context = {\r\n          url,\r\n          title: typeof title === 'function' ? title({params, query, url}) : title,\r\n          params,\r\n          query,\r\n        }\r\n        return route;\r\n      }\r\n    }\r\n    log(`No route matched for ${url.pathname}${url.search}${url.hash}`, url);\r\n    return null;\r\n  }\r\n  \r\n  /**\r\n   * @private\r\n   */\r\n  _notifyUrlChanged() {\r\n    this.dispatchEvent(new RouteEvent(this.context));\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  _onPopState = () => {\r\n    this.navigate(new URL(window.location.href), { backNav: true });\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  _onAnchorClick = (e) => {\r\n    if (\r\n      e.defaultPrevented ||\r\n      e.button !== 0 ||\r\n      e.metaKey ||\r\n      e.ctrlKey ||\r\n      e.shiftKey\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    const a = e.composedPath().find((el) => el.tagName === 'A');\r\n    if (!a || !a.href) return;\r\n\r\n    const url = new URL(a.href);\r\n\r\n    if (this.url.href === url.href) return;\r\n    if (url.host !== window.location.host) return;\r\n    if (a.hasAttribute('download') || a.href.includes('mailto:')) return;\r\n\r\n    const target = a.getAttribute('target');\r\n    if (target && target !== '' && target !== '_self') return;\r\n    \r\n    e.preventDefault();\r\n    this.navigate(url);\r\n  }\r\n\r\n  /**\r\n   * @private \r\n   */\r\n  _collectPlugins(route) {\r\n    return [\r\n      ...(this.config?.plugins ?? []), \r\n      ...(route?.plugins ?? []),\r\n    ]\r\n  }\r\n\r\n  /**\r\n   * @param {string | URL} url The URL to navigate to.\r\n   * @param {{\r\n   *    backNav?: boolean,\r\n   *    replace?: boolean,\r\n   *  }} options options An options object to configure the navigation. The backNav property specifies whether the navigation is a backward navigation, which doesn't push the navigation into browser nav history.\r\n   */\r\n  async navigate(url, options = {}) {\r\n    if (typeof url === 'string') {\r\n      url = new URL(url, this.baseUrl);\r\n    }\r\n    \r\n    let route = this._matchRoute(url) || this._matchRoute(this.fallback);\r\n    log(`Navigating to ${url.pathname}${url.search}${url.hash}`, { context: this.context, route: this.route });\r\n\r\n    /** @type {Plugin[]} */\r\n    let plugins = this._collectPlugins(route);\r\n\r\n    for (const plugin of plugins) {\r\n      try {\r\n        const result = await plugin?.shouldNavigate?.(this.context);\r\n        if (result) {\r\n          const condition = await result.condition();\r\n          if (!condition) {\r\n            url = new URL(result.redirect, this.baseUrl);\r\n            route = this._matchRoute(url) || this._matchRoute(this.fallback);\r\n            plugins = this._collectPlugins(route);\r\n            log('Redirecting', { context: this.context, route: this.route });\r\n          }\r\n        }\r\n      } catch(e) {\r\n        log(`Plugin \"${plugin.name}\" error on shouldNavigate hook`, e);\r\n        throw e;\r\n      }\r\n    }\r\n\r\n    this.route = route;\r\n\r\n    if (!this.route) {\r\n      throw new Error(`[ROUTER] No route or fallback matched for url ${url}`);\r\n    }\r\n\r\n    for (const plugin of plugins) {\r\n      try {\r\n        await plugin?.beforeNavigation?.(this.context);\r\n      } catch(e) {\r\n        log(`Plugin \"${plugin.name}\" error on beforeNavigation hook`, e);\r\n        throw e;\r\n      }\r\n    }\r\n\r\n    if (options?.replace) {\r\n      window.history.replaceState(null, '', `${url.pathname}${url.search}${url.hash}`);\r\n    } else if (!options.backNav) {\r\n      window.history.pushState(null, '', `${url.pathname}${url.search}${url.hash}`);\r\n    }\r\n\r\n    document.title = this.context.title;\r\n    this._notifyUrlChanged();\r\n\r\n    for (const plugin of plugins) {\r\n      try {\r\n        await plugin?.afterNavigation?.(this.context);\r\n      } catch(e) {\r\n        log(`Plugin \"${plugin.name}\" error on afterNavigation hook`, e);\r\n        throw e;\r\n      }\r\n    }\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": ["log"]
}
